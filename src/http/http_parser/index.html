



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://ponylang.github.io/action-testing/src/http/http_parser/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/logo.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-ponylang-0.2.7">
    
    
      
        <title>Http parser - http</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.b80b25f7.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.0b5df86e.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://ponylang.github.io/action-testing/" title="http" class="md-header-nav__button md-logo">
          
            <img src="../../../assets/images/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                http
              </span>
              <span class="md-header-nav__topic">
                Http parser
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../../../assets/images/logo.png" width="48" height="48">
      
    </span>
    http
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="http" class="md-nav__link">
      http
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      package http
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        package http
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http--index/" title="Package" class="md-nav__link">
      Package
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPartUser/" title="primitive URLPartUser" class="md-nav__link">
      primitive URLPartUser
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPartPassword/" title="primitive URLPartPassword" class="md-nav__link">
      primitive URLPartPassword
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPartHost/" title="primitive URLPartHost" class="md-nav__link">
      primitive URLPartHost
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPartPath/" title="primitive URLPartPath" class="md-nav__link">
      primitive URLPartPath
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPartQuery/" title="primitive URLPartQuery" class="md-nav__link">
      primitive URLPartQuery
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPartFragment/" title="primitive URLPartFragment" class="md-nav__link">
      primitive URLPartFragment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPart/" title="type URLPart" class="md-nav__link">
      type URLPart
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLEncode/" title="primitive URLEncode" class="md-nav__link">
      primitive URLEncode
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URL/" title="class URL" class="md-nav__link">
      class URL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-Status/" title="trait Status" class="md-nav__link">
      trait Status
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusContinue/" title="primitive StatusContinue" class="md-nav__link">
      primitive StatusContinue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusSwitchingProtocols/" title="primitive StatusSwitchingProtocols" class="md-nav__link">
      primitive StatusSwitchingProtocols
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusOK/" title="primitive StatusOK" class="md-nav__link">
      primitive StatusOK
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusCreated/" title="primitive StatusCreated" class="md-nav__link">
      primitive StatusCreated
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusAccepted/" title="primitive StatusAccepted" class="md-nav__link">
      primitive StatusAccepted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNonAuthoritativeInfo/" title="primitive StatusNonAuthoritativeInfo" class="md-nav__link">
      primitive StatusNonAuthoritativeInfo
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNoContent/" title="primitive StatusNoContent" class="md-nav__link">
      primitive StatusNoContent
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusResetContent/" title="primitive StatusResetContent" class="md-nav__link">
      primitive StatusResetContent
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusPartialContent/" title="primitive StatusPartialContent" class="md-nav__link">
      primitive StatusPartialContent
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusMultipleChoices/" title="primitive StatusMultipleChoices" class="md-nav__link">
      primitive StatusMultipleChoices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusMovedPermanently/" title="primitive StatusMovedPermanently" class="md-nav__link">
      primitive StatusMovedPermanently
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusFound/" title="primitive StatusFound" class="md-nav__link">
      primitive StatusFound
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusSeeOther/" title="primitive StatusSeeOther" class="md-nav__link">
      primitive StatusSeeOther
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNotModified/" title="primitive StatusNotModified" class="md-nav__link">
      primitive StatusNotModified
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusUseProxy/" title="primitive StatusUseProxy" class="md-nav__link">
      primitive StatusUseProxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusTemporaryRedirect/" title="primitive StatusTemporaryRedirect" class="md-nav__link">
      primitive StatusTemporaryRedirect
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusBadRequest/" title="primitive StatusBadRequest" class="md-nav__link">
      primitive StatusBadRequest
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusUnauthorized/" title="primitive StatusUnauthorized" class="md-nav__link">
      primitive StatusUnauthorized
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusPaymentRequired/" title="primitive StatusPaymentRequired" class="md-nav__link">
      primitive StatusPaymentRequired
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusForbidden/" title="primitive StatusForbidden" class="md-nav__link">
      primitive StatusForbidden
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNotFound/" title="primitive StatusNotFound" class="md-nav__link">
      primitive StatusNotFound
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusMethodNotAllowed/" title="primitive StatusMethodNotAllowed" class="md-nav__link">
      primitive StatusMethodNotAllowed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNotAcceptable/" title="primitive StatusNotAcceptable" class="md-nav__link">
      primitive StatusNotAcceptable
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusProxyAuthRequired/" title="primitive StatusProxyAuthRequired" class="md-nav__link">
      primitive StatusProxyAuthRequired
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusRequestTimeout/" title="primitive StatusRequestTimeout" class="md-nav__link">
      primitive StatusRequestTimeout
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusConflict/" title="primitive StatusConflict" class="md-nav__link">
      primitive StatusConflict
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusGone/" title="primitive StatusGone" class="md-nav__link">
      primitive StatusGone
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusLengthRequired/" title="primitive StatusLengthRequired" class="md-nav__link">
      primitive StatusLengthRequired
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusPreconditionFailed/" title="primitive StatusPreconditionFailed" class="md-nav__link">
      primitive StatusPreconditionFailed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusRequestEntityTooLarge/" title="primitive StatusRequestEntityTooLarge" class="md-nav__link">
      primitive StatusRequestEntityTooLarge
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusRequestURITooLong/" title="primitive StatusRequestURITooLong" class="md-nav__link">
      primitive StatusRequestURITooLong
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusUnsupportedMediaType/" title="primitive StatusUnsupportedMediaType" class="md-nav__link">
      primitive StatusUnsupportedMediaType
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusRequestedRangeNotSatisfiable/" title="primitive StatusRequestedRangeNotSatisfiable" class="md-nav__link">
      primitive StatusRequestedRangeNotSatisfiable
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusExpectationFailed/" title="primitive StatusExpectationFailed" class="md-nav__link">
      primitive StatusExpectationFailed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusTeapot/" title="primitive StatusTeapot" class="md-nav__link">
      primitive StatusTeapot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusPreconditionRequired/" title="primitive StatusPreconditionRequired" class="md-nav__link">
      primitive StatusPreconditionRequired
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusTooManyRequests/" title="primitive StatusTooManyRequests" class="md-nav__link">
      primitive StatusTooManyRequests
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusRequestHeaderFieldsTooLarge/" title="primitive StatusRequestHeaderFieldsTooLarge" class="md-nav__link">
      primitive StatusRequestHeaderFieldsTooLarge
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusUnavailableForLegalReasons/" title="primitive StatusUnavailableForLegalReasons" class="md-nav__link">
      primitive StatusUnavailableForLegalReasons
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusInternalServerError/" title="primitive StatusInternalServerError" class="md-nav__link">
      primitive StatusInternalServerError
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNotImplemented/" title="primitive StatusNotImplemented" class="md-nav__link">
      primitive StatusNotImplemented
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusBadGateway/" title="primitive StatusBadGateway" class="md-nav__link">
      primitive StatusBadGateway
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusServiceUnavailable/" title="primitive StatusServiceUnavailable" class="md-nav__link">
      primitive StatusServiceUnavailable
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusGatewayTimeout/" title="primitive StatusGatewayTimeout" class="md-nav__link">
      primitive StatusGatewayTimeout
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusHTTPVersionNotSupported/" title="primitive StatusHTTPVersionNotSupported" class="md-nav__link">
      primitive StatusHTTPVersionNotSupported
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNetworkAuthenticationRequired/" title="primitive StatusNetworkAuthenticationRequired" class="md-nav__link">
      primitive StatusNetworkAuthenticationRequired
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-Logger/" title="interface Logger" class="md-nav__link">
      interface Logger
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-ServerNotify/" title="interface ServerNotify" class="md-nav__link">
      interface ServerNotify
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HTTPServer/" title="actor HTTPServer" class="md-nav__link">
      actor HTTPServer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-ChunkedTransfer/" title="primitive ChunkedTransfer" class="md-nav__link">
      primitive ChunkedTransfer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StreamTransfer/" title="primitive StreamTransfer" class="md-nav__link">
      primitive StreamTransfer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-OneshotTransfer/" title="primitive OneshotTransfer" class="md-nav__link">
      primitive OneshotTransfer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-TransferMode/" title="type TransferMode" class="md-nav__link">
      type TransferMode
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-Payload/" title="class Payload" class="md-nav__link">
      class Payload
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-MimeTypes/" title="primitive MimeTypes" class="md-nav__link">
      primitive MimeTypes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HTTPSession/" title="interface HTTPSession" class="md-nav__link">
      interface HTTPSession
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-ParseError/" title="primitive ParseError" class="md-nav__link">
      primitive ParseError
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HTTPParser/" title="class HTTPParser" class="md-nav__link">
      class HTTPParser
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-AuthFailed/" title="primitive AuthFailed" class="md-nav__link">
      primitive AuthFailed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-ConnectionClosed/" title="primitive ConnectionClosed" class="md-nav__link">
      primitive ConnectionClosed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-ConnectFailed/" title="primitive ConnectFailed" class="md-nav__link">
      primitive ConnectFailed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HTTPFailureReason/" title="type HTTPFailureReason" class="md-nav__link">
      type HTTPFailureReason
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HTTPHandler/" title="interface HTTPHandler" class="md-nav__link">
      interface HTTPHandler
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HandlerFactory/" title="interface HandlerFactory" class="md-nav__link">
      interface HandlerFactory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-DiscardLog/" title="primitive DiscardLog" class="md-nav__link">
      primitive DiscardLog
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-ContentsLog/" title="class ContentsLog" class="md-nav__link">
      class ContentsLog
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-CommonLog/" title="class CommonLog" class="md-nav__link">
      class CommonLog
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HTTPClient/" title="class HTTPClient" class="md-nav__link">
      class HTTPClient
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Http parser</h1>
                
                <pre><code class="language-pony-full-source">use &quot;buffered&quot;
use &quot;net&quot;
use &quot;encode/base64&quot;

// The parser internal state indicates what it expects to see next
// in the input stream.

primitive _ExpectRequest
primitive _ExpectResponse
primitive _ExpectHeaders
primitive _ExpectContentLength
primitive _ExpectChunkStart
primitive _ExpectChunk
primitive _ExpectChunkEnd
primitive _ExpectBody
primitive _ExpectReady
primitive _ExpectError

type _PayloadState is
  ( _ExpectRequest       // Request method and URL
  | _ExpectResponse      // Response status
  | _ExpectHeaders       // More headers
  | _ExpectContentLength // Body text, limited by Content-Length
  | _ExpectChunkStart    // The start of a 'chunked' piece of body text
  | _ExpectChunk         // More of a continuing body 'chunk'
  | _ExpectChunkEnd      // The CRLF at the end of a 'chunk'
  | _ExpectBody          // Any body, which might not be there
  | _ExpectReady         // All done with the message
  | _ExpectError         // Not valid HTTP format
  )

primitive ParseError

class HTTPParser
  &quot;&quot;&quot;
  This is the HTTP parser that builds a message `Payload` object
  representing either a Request or a Response from received chunks of data.
  &quot;&quot;&quot;
  let _client: Bool
  let _session: HTTPSession
  var _state: _PayloadState  // Parser state
  var _payload: Payload iso  // The Payload under construction
  var _expected_length: USize = 0
  var _transfer_mode: TransferMode = OneshotTransfer
  var _chunk_end: Bool = false
  var _delivered: Bool = false

  new request(session': HTTPSession) =&gt;
    &quot;&quot;&quot;
    Expect HTTP requests to arrive on a session.
    &quot;&quot;&quot;
    _client = false
    _session = session'
    _payload = Payload.request()
    _expected_length = 0
    _transfer_mode = OneshotTransfer
    _chunk_end = false
    _state = _ExpectRequest

  new response(session': HTTPSession) =&gt;
    &quot;&quot;&quot;
    Expect HTTP responses to arrive on a session.
    &quot;&quot;&quot;
    _client = true
    _session = session'
    _payload = Payload.response()
    _expected_length = 0
    _transfer_mode = OneshotTransfer
    _chunk_end = false
    _state = _ExpectResponse

  fun ref parse(buffer: Reader): (ParseError | None) =&gt;
    &quot;&quot;&quot;
    Analyze new data based on the parser's current internal state.
    &quot;&quot;&quot;
    match _state
    | _ExpectRequest =&gt; _parse_request(buffer)
    | _ExpectResponse =&gt; _parse_response(buffer)
    | _ExpectHeaders =&gt; _parse_headers(buffer)
    | _ExpectBody =&gt;
        // We are expecting a message body. Now we decide exactly
        // which encoding to look for.
        match _transfer_mode
        | ChunkedTransfer =&gt;
          _state = _ExpectChunkStart
          _parse_chunk_start(buffer)
        else
          _state = _ExpectContentLength
          _parse_content_length(buffer)
        end
    | _ExpectChunkStart =&gt; _parse_chunk_start(buffer)
    | _ExpectChunk =&gt; _parse_chunk(buffer)
    | _ExpectChunkEnd =&gt; _parse_chunk_end(buffer)
    | _ExpectContentLength =&gt; _parse_content_length(buffer)
    end

  fun ref _deliver() =&gt;
    &quot;&quot;&quot;
    The parser is finished with the message headers so we can push it
    to the `HTTPSession`. The body may come later.
    &quot;&quot;&quot;
    let body_follows = match _payload.transfer_mode
      | ChunkedTransfer =&gt; true
    else
      (_expected_length &gt; 0)
    end

    // Set up `_payload` for the next message.
    let payload = _payload = Payload._empty(_client)
    _session._deliver(consume payload)
    if not body_follows then
      restart()
    end

  fun ref restart() =&gt;
    &quot;&quot;&quot;
    Restart parser state for the next message. It will be of the same
    kind as the last one.
    &quot;&quot;&quot;
    _expected_length = 0
    _transfer_mode = OneshotTransfer
    _chunk_end = false

    _state = if _client then
      _ExpectResponse
    else
      _ExpectRequest
    end

  fun ref closed(buffer: Reader) =&gt;
    &quot;&quot;&quot;
    The connection has closed, which may signal that all remaining data is the
    payload body.
    &quot;&quot;&quot;
    if _state is _ExpectBody then
      _expected_length = buffer.size()

      try
        let bytes = buffer.block(_expected_length)?
        let chunk: ByteSeq = recover val consume bytes end
        match _payload.transfer_mode
        | OneshotTransfer =&gt; _payload.add_chunk(chunk)
        else
          _session._chunk(chunk)
        end
        _state = _ExpectReady
      end
    end

  fun ref _parse_request(buffer: Reader): (ParseError | None) =&gt;
    &quot;&quot;&quot;
    Look for &quot;&lt;Method&gt; &lt;URL&gt; &lt;Proto&gt;&quot;, the first line of an HTTP
    'request' message.
    &quot;&quot;&quot;
    // Reset expectations
    _expected_length = 0
    _transfer_mode = OneshotTransfer
    _payload.session = _session

    try
      let line = buffer.line()?
      let method_end = line.find(&quot; &quot;)?
      _payload.method = line.substring(0, method_end)

      let url_end = line.find(&quot; &quot;, method_end + 1)?
      _payload.url = URL.valid(line.substring(method_end + 1, url_end))?
      _payload.proto = line.substring(url_end + 1)

      _state = _ExpectHeaders
      parse(buffer)
    else
      ParseError
    end

  fun ref _parse_response(buffer: Reader): (ParseError | None) =&gt;
    &quot;&quot;&quot;
    Look for &quot;&lt;Proto&gt; &lt;Code&gt; &lt;Description&gt;&quot;, the first line of an
    HTTP 'response' message.
    &quot;&quot;&quot;
    // Reset expectations
    _expected_length = 0
    _transfer_mode = OneshotTransfer
    _payload.session = _session

    try
      let line = buffer.line()?

      let proto_end = line.find(&quot; &quot;)?
      _payload.proto = line.substring(0, proto_end)
      _payload.status = line.read_int[U16](proto_end + 1)?._1

      let status_end = line.find(&quot; &quot;, proto_end + 1)?
      _payload.method = line.substring(status_end + 1)

      _state = _ExpectHeaders
      parse(buffer)
    else
      ParseError
    end

  fun ref _parse_headers(buffer: Reader): (ParseError | None) =&gt;
    &quot;&quot;&quot;
    Look for: &quot;&lt;Key&gt;:&lt;Value&gt;&quot; or the empty line that marks the end of
    all the headers.
    &quot;&quot;&quot;
    while true do
      // Try to get another line out of the available buffer.
      // If this fails it is not a syntax error; we just wait for more.
      try
        let line = buffer.line()?
        if line.size() == 0 then
          // An empty line marks the end of the headers. Set state
          // appropriately.
          _set_header_end()

          // deliver for empty responses, chunked or streamed transfer
          // accumulate the body in the Payload for OneshotTransfer
          match _payload.transfer_mode
          | OneshotTransfer if _state isnt _ExpectBody =&gt; _deliver()
          | StreamTransfer =&gt;                             _deliver()
          | ChunkedTransfer =&gt;                            _deliver()
          end
          parse(buffer)
        else
          // A non-empty line *must* be a header. error if not.
          try
            _process_header(consume line)?
          else
            _state = _ExpectError
            break
          end
        end // line-size check
      else
        // Failed to get a line. We stay in _ExpectHeader state.
        return
      end // try
    end // looping over all headers in this buffer

    // Breaking out of that loop means an error.
    if _state is _ExpectError then ParseError end

  fun ref _process_header(line: String) ? =&gt;
    &quot;&quot;&quot;
    Save a header value. Raise an error on not finding the colon
    or can't interpret the value.
    &quot;&quot;&quot;
    let i = line.find(&quot;:&quot;)?
    let key = line.substring(0, i)
    key.strip()
    let key2: String val = consume key
    let value = line.substring(i + 1)
    value.strip()
    let value2: String val = consume value

    // Examine certain headers describing the encoding.
    match key2.lower()
    | &quot;content-length&quot; =&gt; // Explicit body length.
      _expected_length = value2.read_int[USize]()?._1
      // On the receiving end, there is no difference
      // between Oneshot and Stream transfers except how
      // we store it. TODO eliminate this?
      _transfer_mode =
        if _expected_length &gt; 10_000 then
          StreamTransfer
        else
          OneshotTransfer
        end
      _payload.transfer_mode = _transfer_mode

    | &quot;transfer-encoding&quot; =&gt; // Incremental body lengths.
      try
        value2.find(&quot;chunked&quot;)?
        _transfer_mode = ChunkedTransfer
        _payload.transfer_mode = _transfer_mode
      else
        _state = _ExpectError
      end

    | &quot;Host&quot; =&gt;
      // TODO: set url host and service
      None

    | &quot;authorization&quot; =&gt; _setauth(value2)

    end // match certain headers

    _payload(key2) = value2

  fun ref _setauth(auth: String) =&gt;
    &quot;&quot;&quot;
    Fill in username and password from an authentication header.
    &quot;&quot;&quot;
    try
      let parts = auth.split(&quot; &quot;)
      let authscheme = parts(0)?
      match authscheme.lower()
      | &quot;basic&quot; =&gt;
        let autharg = parts(1)?
        let userpass = Base64.decode[String iso](autharg)?
        let uparts = userpass.split(&quot;:&quot;)
        _payload.username = uparts(0)?
        _payload.password = uparts(1)?
      end
    end

  fun ref _set_header_end() =&gt;
    &quot;&quot;&quot;
    Line size is zero, so we have reached the end of the headers.
    Certain status codes mean there is no body.
    &quot;&quot;&quot;
    if
      (_payload.status == 204) // no content
        or (_payload.status == 304) // not modified
        or ((_payload.status &gt; 0) and (_payload.status &lt; 200))
    then
      _state = _ExpectReady
    else
      // If chunked mode or length&gt;0 then some body data will follow.
      // In any case we can pass the completed `Payload` on to the
      // session for processing.
      _state = match _payload.transfer_mode
      | ChunkedTransfer =&gt;
        _ExpectChunkStart
      else
        if _expected_length == 0 then
          _ExpectReady
        else
          _ExpectBody
        end
      end
    end // else no special status

  fun ref _parse_content_length(buffer: Reader) =&gt;
    &quot;&quot;&quot;
    Look for `_expected_length` bytes set by having seen a `Content-Length`
    header. We may not see it all at once but we process the lesser of
    what we need and what is available in the buffer.
    &quot;&quot;&quot;
    let available = buffer.size()
    let usable = available.min(_expected_length)

    try
      let bytes = buffer.block(usable)?
      let body = recover val consume bytes end
      _expected_length = _expected_length - usable
      // in streaming mode we already have a new unrelated payload in _payload
      // so we need to keep track of the current transfer-mode via _transfer_mode
      match _transfer_mode
      | OneshotTransfer =&gt;
        // in oneshot transfer we actually fill the body of the payload
        _payload.add_chunk(body)
      else
        _session._chunk(body)
      end

      // All done with this message if we have processed the entire body.
      if _expected_length == 0 then
        match _transfer_mode
        | OneshotTransfer =&gt;
          // we have all the body, finally deliver it
          _deliver()
        else
          // explicitly finish the session in chunked and stream mode
          _session._finish()
        end
        restart()
      end
    end

  fun ref _parse_chunk_start(buffer: Reader): (ParseError | None) =&gt;
    &quot;&quot;&quot;
    Look for the beginning of a chunk, which is a length in hex on a line
    terminated by CRLF. An explicit length of zero marks the end of
    the entire chunked message body.
    &quot;&quot;&quot;
    let line = try
      buffer.line()?
    else
      return ParseError
    end

    if line.size() &gt; 0
    then
      // This should be the length of the next chunk.
      _expected_length = try
        line.read_int[USize](0, 16)?._1
      else
        return ParseError
      end
      // A chunk explicitly of length zero marks the end of the body.
      if _expected_length &gt; 0 then
        _state = _ExpectChunk
      else
        // We already have the CRLF after the zero, so we are all done.
        _session._finish()
        restart()
      end

      parse(buffer)
    else
      // Anything other than a length is an error.
      _expected_length = 0
      _state = _ExpectError
      ParseError
    end

  fun ref _parse_chunk(buffer: Reader) =&gt;
    &quot;&quot;&quot;
    Look for a chunk of the size set by `_parse_chunk_start`. We may
    not see it all at once but we process the lesser of what we need
    and what is available in the buffer. ChunkedTransfer mode always
    delivers directly to the HTTPSession handler.
    &quot;&quot;&quot;
    let available = buffer.size()
    let usable = available.min(_expected_length)
    try
      let chunk = buffer.block(usable)?
      _session._chunk(consume chunk)
      _expected_length = _expected_length - usable

      // If we have all of the chunk, look for the trailing CRLF.
      // Otherwise we will keep working on this chunk.
      if _expected_length == 0 then
        _state = _ExpectChunkEnd
        parse(buffer)
        end
    end

  fun ref _parse_chunk_end(buffer: Reader) =&gt;
    &quot;&quot;&quot;
    Look for the CRLF that ends every chunk. AFter that we look for
    the next chunk, or that was the special ending chunk.
    &quot;&quot;&quot;
    try
      let line = buffer.line()?
      if _chunk_end
      then
        _session._finish()
        restart()
      else
        _state = _ExpectChunkStart
        parse(buffer)
      end
    end

/* Saved for debugging.
  fun ref _say() =&gt;
    match _state
    | _ExpectRequest =&gt; Debug.out(&quot;-Request method and URL&quot;)
    | _ExpectResponse =&gt; Debug.out(&quot;-Response status&quot;)
    | _ExpectHeaders =&gt; Debug.out(&quot;-More headers&quot;)
    | _ExpectContentLength =&gt;
      Debug.out(&quot;-Body text, limited by Content-Length&quot;)
    | _ExpectChunkStart =&gt;
      Debug.out(&quot;-The start of a 'chunked' piece of body text&quot;)
    | _ExpectChunk =&gt; Debug.out(&quot;-More of a continuing body 'chunk'&quot;)
    | _ExpectChunkEnd =&gt; Debug.out(&quot;-The CRLF at the end of a 'chunk'&quot;)
    | _ExpectBody =&gt; Debug.out(&quot;-Any body, which might not be there&quot;)
    | _ExpectReady =&gt; Debug.out(&quot;-All done with the message&quot;)
    | _ExpectError =&gt; Debug.out(&quot;-Not valid HTTP format&quot;)
    end
*/

</code></pre>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
    <script src="../../../assets/javascripts/application.cb37bb38.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:"../../.."}})</script>
      
    
    
      
    
  </body>
</html>
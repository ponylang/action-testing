



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://ponylang.github.io/action-testing/src/http/payload/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/logo.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-ponylang-0.2.8">
    
    
      
        <title>Payload - http</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.b80b25f7.css">
      
    
    
      <script src="../../../assets/javascripts/modernizr.0b5df86e.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://ponylang.github.io/action-testing/" title="http" class="md-header-nav__button md-logo">
          
            <img src="../../../assets/images/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                http
              </span>
              <span class="md-header-nav__topic">
                Payload
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../../../assets/images/logo.png" width="48" height="48">
      
    </span>
    http
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="http" class="md-nav__link">
      http
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      package http
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        package http
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http--index/" title="Package" class="md-nav__link">
      Package
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPartUser/" title="primitive URLPartUser" class="md-nav__link">
      primitive URLPartUser
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPartPassword/" title="primitive URLPartPassword" class="md-nav__link">
      primitive URLPartPassword
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPartHost/" title="primitive URLPartHost" class="md-nav__link">
      primitive URLPartHost
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPartPath/" title="primitive URLPartPath" class="md-nav__link">
      primitive URLPartPath
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPartQuery/" title="primitive URLPartQuery" class="md-nav__link">
      primitive URLPartQuery
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPartFragment/" title="primitive URLPartFragment" class="md-nav__link">
      primitive URLPartFragment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLPart/" title="type URLPart" class="md-nav__link">
      type URLPart
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URLEncode/" title="primitive URLEncode" class="md-nav__link">
      primitive URLEncode
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-URL/" title="class URL" class="md-nav__link">
      class URL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-Status/" title="trait Status" class="md-nav__link">
      trait Status
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusContinue/" title="primitive StatusContinue" class="md-nav__link">
      primitive StatusContinue
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusSwitchingProtocols/" title="primitive StatusSwitchingProtocols" class="md-nav__link">
      primitive StatusSwitchingProtocols
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusOK/" title="primitive StatusOK" class="md-nav__link">
      primitive StatusOK
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusCreated/" title="primitive StatusCreated" class="md-nav__link">
      primitive StatusCreated
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusAccepted/" title="primitive StatusAccepted" class="md-nav__link">
      primitive StatusAccepted
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNonAuthoritativeInfo/" title="primitive StatusNonAuthoritativeInfo" class="md-nav__link">
      primitive StatusNonAuthoritativeInfo
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNoContent/" title="primitive StatusNoContent" class="md-nav__link">
      primitive StatusNoContent
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusResetContent/" title="primitive StatusResetContent" class="md-nav__link">
      primitive StatusResetContent
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusPartialContent/" title="primitive StatusPartialContent" class="md-nav__link">
      primitive StatusPartialContent
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusMultipleChoices/" title="primitive StatusMultipleChoices" class="md-nav__link">
      primitive StatusMultipleChoices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusMovedPermanently/" title="primitive StatusMovedPermanently" class="md-nav__link">
      primitive StatusMovedPermanently
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusFound/" title="primitive StatusFound" class="md-nav__link">
      primitive StatusFound
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusSeeOther/" title="primitive StatusSeeOther" class="md-nav__link">
      primitive StatusSeeOther
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNotModified/" title="primitive StatusNotModified" class="md-nav__link">
      primitive StatusNotModified
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusUseProxy/" title="primitive StatusUseProxy" class="md-nav__link">
      primitive StatusUseProxy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusTemporaryRedirect/" title="primitive StatusTemporaryRedirect" class="md-nav__link">
      primitive StatusTemporaryRedirect
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusBadRequest/" title="primitive StatusBadRequest" class="md-nav__link">
      primitive StatusBadRequest
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusUnauthorized/" title="primitive StatusUnauthorized" class="md-nav__link">
      primitive StatusUnauthorized
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusPaymentRequired/" title="primitive StatusPaymentRequired" class="md-nav__link">
      primitive StatusPaymentRequired
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusForbidden/" title="primitive StatusForbidden" class="md-nav__link">
      primitive StatusForbidden
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNotFound/" title="primitive StatusNotFound" class="md-nav__link">
      primitive StatusNotFound
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusMethodNotAllowed/" title="primitive StatusMethodNotAllowed" class="md-nav__link">
      primitive StatusMethodNotAllowed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNotAcceptable/" title="primitive StatusNotAcceptable" class="md-nav__link">
      primitive StatusNotAcceptable
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusProxyAuthRequired/" title="primitive StatusProxyAuthRequired" class="md-nav__link">
      primitive StatusProxyAuthRequired
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusRequestTimeout/" title="primitive StatusRequestTimeout" class="md-nav__link">
      primitive StatusRequestTimeout
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusConflict/" title="primitive StatusConflict" class="md-nav__link">
      primitive StatusConflict
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusGone/" title="primitive StatusGone" class="md-nav__link">
      primitive StatusGone
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusLengthRequired/" title="primitive StatusLengthRequired" class="md-nav__link">
      primitive StatusLengthRequired
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusPreconditionFailed/" title="primitive StatusPreconditionFailed" class="md-nav__link">
      primitive StatusPreconditionFailed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusRequestEntityTooLarge/" title="primitive StatusRequestEntityTooLarge" class="md-nav__link">
      primitive StatusRequestEntityTooLarge
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusRequestURITooLong/" title="primitive StatusRequestURITooLong" class="md-nav__link">
      primitive StatusRequestURITooLong
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusUnsupportedMediaType/" title="primitive StatusUnsupportedMediaType" class="md-nav__link">
      primitive StatusUnsupportedMediaType
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusRequestedRangeNotSatisfiable/" title="primitive StatusRequestedRangeNotSatisfiable" class="md-nav__link">
      primitive StatusRequestedRangeNotSatisfiable
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusExpectationFailed/" title="primitive StatusExpectationFailed" class="md-nav__link">
      primitive StatusExpectationFailed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusTeapot/" title="primitive StatusTeapot" class="md-nav__link">
      primitive StatusTeapot
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusPreconditionRequired/" title="primitive StatusPreconditionRequired" class="md-nav__link">
      primitive StatusPreconditionRequired
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusTooManyRequests/" title="primitive StatusTooManyRequests" class="md-nav__link">
      primitive StatusTooManyRequests
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusRequestHeaderFieldsTooLarge/" title="primitive StatusRequestHeaderFieldsTooLarge" class="md-nav__link">
      primitive StatusRequestHeaderFieldsTooLarge
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusUnavailableForLegalReasons/" title="primitive StatusUnavailableForLegalReasons" class="md-nav__link">
      primitive StatusUnavailableForLegalReasons
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusInternalServerError/" title="primitive StatusInternalServerError" class="md-nav__link">
      primitive StatusInternalServerError
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNotImplemented/" title="primitive StatusNotImplemented" class="md-nav__link">
      primitive StatusNotImplemented
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusBadGateway/" title="primitive StatusBadGateway" class="md-nav__link">
      primitive StatusBadGateway
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusServiceUnavailable/" title="primitive StatusServiceUnavailable" class="md-nav__link">
      primitive StatusServiceUnavailable
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusGatewayTimeout/" title="primitive StatusGatewayTimeout" class="md-nav__link">
      primitive StatusGatewayTimeout
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusHTTPVersionNotSupported/" title="primitive StatusHTTPVersionNotSupported" class="md-nav__link">
      primitive StatusHTTPVersionNotSupported
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StatusNetworkAuthenticationRequired/" title="primitive StatusNetworkAuthenticationRequired" class="md-nav__link">
      primitive StatusNetworkAuthenticationRequired
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-Logger/" title="interface Logger" class="md-nav__link">
      interface Logger
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-ServerNotify/" title="interface ServerNotify" class="md-nav__link">
      interface ServerNotify
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HTTPServer/" title="actor HTTPServer" class="md-nav__link">
      actor HTTPServer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-ChunkedTransfer/" title="primitive ChunkedTransfer" class="md-nav__link">
      primitive ChunkedTransfer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-StreamTransfer/" title="primitive StreamTransfer" class="md-nav__link">
      primitive StreamTransfer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-OneshotTransfer/" title="primitive OneshotTransfer" class="md-nav__link">
      primitive OneshotTransfer
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-TransferMode/" title="type TransferMode" class="md-nav__link">
      type TransferMode
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-Payload/" title="class Payload" class="md-nav__link">
      class Payload
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-MimeTypes/" title="primitive MimeTypes" class="md-nav__link">
      primitive MimeTypes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HTTPSession/" title="interface HTTPSession" class="md-nav__link">
      interface HTTPSession
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-ParseError/" title="primitive ParseError" class="md-nav__link">
      primitive ParseError
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HTTPParser/" title="class HTTPParser" class="md-nav__link">
      class HTTPParser
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-AuthFailed/" title="primitive AuthFailed" class="md-nav__link">
      primitive AuthFailed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-ConnectionClosed/" title="primitive ConnectionClosed" class="md-nav__link">
      primitive ConnectionClosed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-ConnectFailed/" title="primitive ConnectFailed" class="md-nav__link">
      primitive ConnectFailed
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HTTPFailureReason/" title="type HTTPFailureReason" class="md-nav__link">
      type HTTPFailureReason
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HTTPHandler/" title="interface HTTPHandler" class="md-nav__link">
      interface HTTPHandler
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HandlerFactory/" title="interface HandlerFactory" class="md-nav__link">
      interface HandlerFactory
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-DiscardLog/" title="primitive DiscardLog" class="md-nav__link">
      primitive DiscardLog
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-ContentsLog/" title="class ContentsLog" class="md-nav__link">
      class ContentsLog
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-CommonLog/" title="class CommonLog" class="md-nav__link">
      class CommonLog
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../http-HTTPClient/" title="class HTTPClient" class="md-nav__link">
      class HTTPClient
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Payload</h1>
                
                <pre><code class="language-pony-full-source">use &quot;collections&quot;
use &quot;net&quot;
use &quot;format&quot;

primitive ChunkedTransfer
primitive StreamTransfer
primitive OneshotTransfer

type TransferMode is (ChunkedTransfer | StreamTransfer | OneshotTransfer)

class trn Payload
  &quot;&quot;&quot;
  This class represent a single HTTP message, which can be either a
  `request` or a `response`.

  ### Transfer Modes

  HTTP provides two ways to encode the transmission of a message 'body',
  of any size. This package supports both of them:

  2. **StreamTransfer**. This is used for payload bodies where the exact
    length is known in advance, including most transfers of files. It is
    selected by calling `Payload.set_length` with an integer bytecount.
    Appication buffer sizes determine how much data is fed to the TCP
    connection at once, but the total amount must match this size.

  3. **ChunkedTransfer**. This is used when the payload length can not be
    known in advance, but can be large. It is selected by calling
    `Payload.set_length` with a parameter of `None`. On the TCP link this mode
    can be detected because there is no `Content-Length` header at all, being
    replaced by the `Transfer-Encoding: chunked` header. In addition, the
    message body is separated into chunks, each with its own bytecount. As with
    `StreamTransfer` mode, transmission can be spread out over time with the
    difference that it is the original data source that determines the chunk
    size.

    If `Payload.set_length` is never called at all, a variation on
    `StreamTransfer` called `OneshotTransfer` is used. In this case, all of
    the message body is placed into the message at once, using
    `Payload.add_chunk` calls. The size will be determined when the message is
    submitted for transmission. Care must be taken not to consume too much
    memory, especially on a server where there can be multiple messages in
    transit at once.

    The type of transfer being used by an incoming message can be determined
    from its `transfer_mode` field, which will be one of the
    [TransferMode](http-TransferMode) types.

  ### Sequence

  For example, to send a message of possibly large size:

  1. Create the message with a call to `Payload.request` or `Payload.response`.
  2. Set the `session` field of the message.
  2. Call `Payload.set_length` to indicate the length of the body.
  3. Add any additional headers that may be required, such as `Content-type`.
  4. Submit the message for transmission by calling the either the
  `HTTPSession.apply` method (in servers) or the `HTTPCLient.apply` method
  in clients.
  5. Wait for the `send_body` notification.
  6. Make any number of calls to `Payload.send_chunk`.
  7. Call `Payload.finish`.

  To send a message of small, reasonable size (say, under 20KB), this
  simplified method can be used instead:

  1. Create the message with a call to `Payload.request` or `Payload.response`.
  2. Set the `session` field of the message.
  3. Add any additional headers that may be required, such as `Content-type`.
  4. Call `add_chunk` one or more times to add body data.
  4. Submit the message for transmission by calling the either the
  [HTTPSession](http-HTTPSession)`.apply` method (in servers) or the
  [HTTPClient](http-HTTPClient)`.apply` method in clients.
  &quot;&quot;&quot;
  var proto: String = &quot;HTTP/1.1&quot;
    &quot;&quot;&quot;The HTTP protocol string&quot;&quot;&quot;

  var status: U16
    &quot;&quot;&quot;
    Internal representation of the response [Status](http-Status).

    Will be `0` for HTTP requests.
    &quot;&quot;&quot;

  var method: String
    &quot;&quot;&quot;
    The HTTP Method.

    `GET`, `POST`, `DELETE`, `OPTIONS`, ...

    For HTTP responses this will be the status string,
    for a `200` status this will be `200 OK`, for `404`, `404 Not Found` etc..
    &quot;&quot;&quot;

  var url: URL
    &quot;&quot;&quot;
    The HTTP request [URL](http-URL).
    It will be used for the HTTP path and the `Host` header.
    The `user` and `password` fields are ignored.

    For HTTP responses this will be an empty [URL](http-URL).
    &quot;&quot;&quot;
  var _body_length: USize = 0
  var transfer_mode: TransferMode = OneshotTransfer
    &quot;&quot;&quot;
    Determines the transfer mode of this message.

    In case of outgoing requests or responses,
    use `set_length` to control the transfer mode.

    In case of incoming requests, this field determines
    how the request is transferred.
    &quot;&quot;&quot;
  var session: (HTTPSession | None) = None

  embed _headers: Map[String, String] = _headers.create()
  embed _body: Array[ByteSeq val] = _body.create()
  let _response: Bool
  var username: String = &quot;&quot;
    &quot;&quot;&quot;
    The username extracted from an `Authentication` header of an HTTP request
    received via [HTTPServer](http-HTTPServer).

    This is not used and not sent using [HTTPClient](http-HTTPClient),
    use `update` to set an `Authentication` header instead.
    &quot;&quot;&quot;
  var password: String = &quot;&quot;
    &quot;&quot;&quot;
    The password extracted from an `Authentication` header of an HTTP request
    received via [HTTPServer](http-HTTPServer).

    This is not used and not sent using [HTTPClient](http-HTTPClient),
    use `update` to set an `Authentication` header instead.
    &quot;&quot;&quot;

  new iso request(method': String = &quot;GET&quot;, url': URL = URL) =&gt;
    &quot;&quot;&quot;
    Create an HTTP `request` message.
    &quot;&quot;&quot;
    status = 0
    method = method'
    url = url'
    _response = false

  new iso response(status': Status = StatusOK) =&gt;
    &quot;&quot;&quot;
    Create an HTTP `response` message.
    &quot;&quot;&quot;
    status = status'()
    method = status'.string()
    url = URL
    _response = true

  new iso _empty(response': Bool = true) =&gt;
    &quot;&quot;&quot;
    Create an empty HTTP payload.
    &quot;&quot;&quot;
    status = 0
    method = &quot;&quot;
    url = URL
    _response = response'

  fun apply(key: String): String ? =&gt;
    &quot;&quot;&quot;
    Get a header.
    &quot;&quot;&quot;
    _headers(key)?

  fun is_safe(): Bool =&gt;
    &quot;&quot;&quot;
    A request method is &quot;safe&quot; if it does not modify state in the resource.
    These methods can be guaranteed not to have any body data.
    Return true for a safe request method, false otherwise.
    &quot;&quot;&quot;
    match method
    | &quot;GET&quot;
    | &quot;HEAD&quot;
    | &quot;OPTIONS&quot; =&gt;
      true
    else
      false
    end

  fun body(): this-&gt;Array[ByteSeq] ? =&gt;
    &quot;&quot;&quot;
    Get the body in `OneshotTransfer` mode.
    In the other modes it raises an error.
    &quot;&quot;&quot;
    match transfer_mode
    | OneshotTransfer =&gt; _body
    else error
    end

  fun ref set_length(bytecount: (USize | None)) =&gt;
    &quot;&quot;&quot;
    Set the body length when known in advance. This determines the
    transfer mode that will be used. A parameter of 'None' will use
    Chunked Transfer Encoding. A numeric value will use Streamed
    transfer. Not calling this function at all will
    use Oneshot transfer.
    &quot;&quot;&quot;
    match bytecount
    | None  =&gt;
      transfer_mode = ChunkedTransfer
      _headers(&quot;Transfer-Encoding&quot;) = &quot;chunked&quot;
    | let n: USize =&gt;
      try not _headers.contains(&quot;Content-Length&quot;) then
        _headers(&quot;Content-Length&quot;) = n.string()
      end
      _body_length = n
      transfer_mode = StreamTransfer
    end

  fun ref update(key: String, value: String): Payload ref^ =&gt;
    &quot;&quot;&quot;
    Set any header. If we've already received the header, append the value as a
    comma separated list, as per RFC 2616 section 4.2.
    &quot;&quot;&quot;
    match _headers(key) = value
    | let prev: String =&gt;
      _headers(key) = prev + &quot;,&quot; + value
    end
    this

  fun headers(): this-&gt;Map[String, String] =&gt;
    &quot;&quot;&quot;
    Get all the headers.
    &quot;&quot;&quot;
    _headers

  fun body_size(): (USize | None) =&gt;
    &quot;&quot;&quot;
    Get the total intended size of the body.
    `ServerConnection` accumulates actual size transferred for logging.
    &quot;&quot;&quot;
    match transfer_mode
    | ChunkedTransfer =&gt; None
    else _body_length
    end

  fun ref add_chunk(data: ByteSeq val): Payload ref^ =&gt;
    &quot;&quot;&quot;
    This is how application code adds data to the body in
    `OneshotTransfer` mode. For large bodies, call `set_length`
    and use `send_chunk` instead.
    &quot;&quot;&quot;
    _body.push(data)
    _body_length = _body_length + data.size()

    this

  fun box send_chunk(data: ByteSeq val) =&gt;
    &quot;&quot;&quot;
    This is how application code sends body data in `StreamTransfer` and
    `ChunkedTransfer` modes. For smaller body lengths, `add_chunk` in
    `Oneshot` mode can be used instead.
    &quot;&quot;&quot;
    match session
    | let s: HTTPSession =&gt;
      match transfer_mode
      | ChunkedTransfer =&gt;
        // Wrap some body data in the Chunked Transfer Encoding format,
        // which is the length in hex, the data, and a CRLF. It is
        // important to never send a chunk of length zero, as that is
        // how the end of the body is signalled.
        s.write(Format.int[USize](data.size(), FormatHexBare))
        s.write(&quot;\r\n&quot;)
        s.write(data)
        s.write(&quot;\r\n&quot;)
      | StreamTransfer =&gt;
        // In stream mode just send the data. Its length should have
        // already been accounted for by `set_length`.
        s.write(data)
      end
    end

  fun val finish() =&gt;
    &quot;&quot;&quot;
    Mark the end of body transmission. This does not do anything,
    and is unnecessary, in Oneshot mode.
    &quot;&quot;&quot;
    match session
    | let s: HTTPSession =&gt;
      match transfer_mode
      | ChunkedTransfer =&gt;
        s.write(&quot;0\r\n\r\n&quot;)
        s.finish()
      | StreamTransfer =&gt;
        s.finish()
      end
    end

  fun val respond(response': Payload) =&gt;
    &quot;&quot;&quot;
    Start sending a response from the server to the client.
    &quot;&quot;&quot;
    try
      (session as HTTPSession)(consume response')
    end

  fun val _client_fail() =&gt;
    &quot;&quot;&quot;
    Start sending an error response.
    &quot;&quot;&quot;
    None
    /* Not sure if we need this. Nobody calls it. But something like:
    try
      (session as HTTPSession)(
        Payload.response(StatusInternalServerError))
    end
    */

  fun val _write(keepalive: Bool = true, conn: TCPConnection tag) =&gt;
    &quot;&quot;&quot;
    Writes the payload to an HTTPSession. Requests and Responses differ
    only in the first line of text - everything after that is the same format.
    &quot;&quot;&quot;
    if _response then
      _write_response(keepalive, conn)
    else
      _write_request(keepalive, conn)
    end

    _write_common(conn)

  fun val _write_request(keepalive: Bool, conn: TCPConnection tag) =&gt;
    &quot;&quot;&quot;
    Writes the 'request' parts of an HTTP message.
    &quot;&quot;&quot;
    conn.write(method + &quot; &quot; + url.path)

    if url.query.size() &gt; 0 then
      conn.write(&quot;?&quot; + url.query)
      end

    if url.fragment.size() &gt; 0 then
      conn.write(&quot;#&quot; + url.fragment)
      end

    conn.write(&quot; &quot; + proto + &quot;\r\n&quot;)

    if not keepalive then
      conn.write(&quot;Connection: close\r\n&quot;)
    end

    if url.port == url.default_port() then
      conn.write(&quot;Host: &quot; + url.host + &quot;\r\n&quot;)
    else
      conn.write(&quot;Host: &quot; + url.host + &quot;:&quot;  + url.port.string() + &quot;\r\n&quot;)
    end

  fun val _write_common(conn: TCPConnection tag) =&gt;
    &quot;&quot;&quot;
    Writes the parts of an HTTP message common to both requests and
    responses.
    &quot;&quot;&quot;
    _write_headers(conn)

    // In oneshot mode we send the entire stored body.
    if transfer_mode is OneshotTransfer then
      for piece in _body.values() do
        conn.write(piece)
      end
    end

  fun val _write_response(keepalive: Bool, conn: TCPConnection tag) =&gt;
    &quot;&quot;&quot;
    Write the response-specific parts of an HTTP message. This is the
    status line, consisting of the protocol name, the status value,
    and a string representation of the status (carried in the `method`
    field). Since writing it out is an actor behavior call, we go to
    the trouble of packaging it into a single string before sending.
    &quot;&quot;&quot;
    let statusline =
      recover
        String(proto.size() + status.string().size() + method.size() + 4)
      end

    statusline
      .&gt; append(proto)
      .&gt; append(&quot; &quot;)
      .&gt; append(status.string())
      .&gt; append(&quot; &quot;)
      .&gt; append(method)
      .&gt; append(&quot;\r\n&quot;)
    conn.write(consume statusline)

    if keepalive then
      conn.write(&quot;Connection: keep-alive\r\n&quot;)
    end

  fun _write_headers(conn: TCPConnection tag) =&gt;
    &quot;&quot;&quot;
    Write all of the HTTP headers to the comm link.
    &quot;&quot;&quot;
    var saw_length: Bool = false
    for (k, v) in _headers.pairs() do
      if (k != &quot;Host&quot;) then
        if k == &quot;Content-Length&quot; then saw_length = true end
        conn.write(k + &quot;: &quot; + v + &quot;\r\n&quot;)
      end
    end

    if (not saw_length) and (transfer_mode is OneshotTransfer) then
      conn.write(&quot;Content-Length: &quot; + _body_length.string() + &quot;\r\n&quot;)
    end

    // Blank line before the body.
    conn.write(&quot;\r\n&quot;)

  fun box has_body(): Bool =&gt;
    &quot;&quot;&quot;
    Determines whether a message has a body portion.
    &quot;&quot;&quot;
    if _response then
      // Errors never have bodies.
      if
        (status == 204) // no content
          or (status == 304) // not modified
          or ((status &gt; 0) and (status &lt; 200))
          or (status &gt; 400)
      then
        false
      else
        true
      end
    else
      match transfer_mode
      | ChunkedTransfer =&gt; true
      else (_body_length &gt; 0)
      end
    end

</code></pre>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
    <script src="../../../assets/javascripts/application.cb37bb38.js"></script>
      
      <script>app.initialize({version:"1.1.2",url:{base:"../../.."}})</script>
      
    
    
      
    
  </body>
</html>